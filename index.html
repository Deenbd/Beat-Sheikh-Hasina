<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Juta Maro Game - Comment</title>
<link href="logo.png" rel="icon" />
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#d3413f;
  font-family:Arial,sans-serif;
  color:#fff;
  height:100vh;
  display:flex;
  flex-direction:column
}
#box{
  flex:1;
  overflow-y:auto;
  padding:20px 15px 180px
}
.c{
  background:#efc7c7;
  color:#333;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
  display:flex;
  gap:14px
}
.avatar{
  width:44px;
  height:44px;
  min-width:44px;
  min-height:44px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid #fff;
  box-shadow:0 2px 8px rgba(0,0,0,0.4)
}
.n{font-weight:bold;color:#900}
.t{font-size:11px;color:#900;opacity:0.8}
.m{line-height:1.5}

.inp{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#772524;
  padding:16px;
  box-shadow:0 -4px 20px rgba(0,0,0,0.4)
}
.r{
  display:flex;
  gap:12px;
  align-items:center;
  margin-bottom:12px
}
input{
  flex:1;
  padding:14px;
  border-radius:30px;
  border:none;
  outline:none;
  font-size:15px
}
button{
  background:none;
  border:none;
  cursor:pointer;
  width:50px;
  display:flex;
  justify-content:center
}
.file-btn{
  background:#ff9800;
  color:#fff;
  padding:12px 20px;
  border-radius:30px;
  font-weight:bold
}
#si{opacity:1;transition:opacity .3s}
</style>
</head>

<body>

<div id="box">Loading...</div>

<div class="inp">
  <div class="r">
    <button class="file-btn" onclick="document.getElementById('f').click()">Image</button>
    <input id="n" placeholder="Scratch username">
    <button onclick="loadComments()">
      <img src="reload.png" width="28">
    </button>
  </div>

  <div class="r">
    <input id="m" placeholder="Comment">
    <button onclick="send()">
      <img src="send.png" width="28" id="si">
    </button>
  </div>
</div>

<input type="file" id="f" accept="image/*" style="display:none">

<script>
const URL = 'https://script.google.com/macros/s/AKfycbx_XLZ-IRyA0YLlIG1nRbPDYsAk0lO4kC13iLShT5tnVKDt8ytJCnNKyn_WC10xghEEjQ/exec';

let lastCount = 0;
let isSending = false;

/* ---------- LOAD COMMENTS ---------- */
function loadComments(auto = false) {
  fetch(URL)
    .then(r => r.json())
    .then(d => {
      if (!d.comments) return;

      // auto-refresh হলে নতুন কিছু না এলে কিছু করবে না
      if (auto && d.comments.length === lastCount) return;

      const b = document.getElementById('box');
      b.innerHTML = '';

      d.comments.forEach(c => {
        const pic = c.pic || 'https://via.placeholder.com/44?text=?';
        const div = document.createElement('div');
        div.className = 'c';
        div.innerHTML = `
          <img src="${pic}" class="avatar">
          <div>
            <div class="n">${c.name}</div>
            <div class="t">${new Date(c.timestamp).toLocaleString('bn-BD')}</div>
            <div class="m">${c.comment || ''}</div>
          </div>
        `;
        b.appendChild(div);
      });

      lastCount = d.comments.length;
      b.scrollTop = b.scrollHeight;
    })
    .catch(() => {
      document.getElementById('box').innerHTML =
        '<div style="text-align:center;padding:60px">Loading error!</div>';
    });
}

/* ---------- SEND MESSAGE ---------- */
function send() {
  if (isSending) return;

  const name = n.value.trim();
  const msg = m.value.trim();
  const file = f.files[0];

  if (!name) return alert('Please enter your Scratch account username!');
  if (!msg && !file) return alert('Please enter comment or profile picture!');

  isSending = true;
  si.style.opacity = '0.4';

  const payload = { name, comment: msg };

  if (file) {
    const fr = new FileReader();
    fr.onload = e => {
      payload.file = e.target.result.split(',')[1];
      payload.filename = file.name;
      payload.mimetype = file.type;
      post(payload);
    };
    fr.readAsDataURL(file);
  } else {
    post(payload);
  }

  function post(data) {
    fetch(URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    }).then(() => {
      // (NO reload)
      appendLocal(name, msg, file);
      m.value='';
      f.value='';
      si.style.opacity='1';
      isSending=false;
    }).catch(()=>{
      alert('Error send! Please try again!');
      si.style.opacity='1';
      isSending=false;
    });
  }
}

 /* ---------- LOCAL APPEND ---------- */
function appendLocal(name, msg, file) {
  const b = document.getElementById('box');
  const pic = file ? URL.createObjectURL(file)
                   : 'https://via.placeholder.com/44?text=?';

  const div = document.createElement('div');
  div.className='c';
  div.innerHTML=`
    <img src="${pic}" class="avatar">
    <div>
      <div class="n">${name}</div>
      <div class="t">${new Date().toLocaleString('bn-BD')}</div>
      <div class="m">${msg || ''}</div>
    </div>
  `;
  b.appendChild(div);
  b.scrollTop = b.scrollHeight;
}

/* ---------- AUTO REFRESH (OTHERS SEE) ---------- */
setInterval(()=>{
  if(!isSending) loadComments(true);
},5000);

/* ---------- INIT ---------- */
loadComments();

m.addEventListener('keypress',e=>{
  if(e.key==='Enter') send();
});
</script>
</body>
</html>
